# Despliegue y documentaciÃ³n

![Deployment Diagram](https://github.com/user-attachments/assets/692528cb-5526-43e3-afa8-f54fc2c2522b)

## DescripciÃ³n de la Infraestructura

### Servidor Host

**Sistema Operativo:** Ubuntu Server 24.04 LTS  
**Docker Engine:** 20.10+  
**Docker Compose:** 2.x

### Contenedores Docker (6 servicios)

#### 1. **anb_nginx** - Reverse Proxy
- **Imagen:** `nginx:alpine`
- **Puertos Expuestos:** 
  - `80:80` (HTTP)
  - `443:443` (HTTPS)
- **FunciÃ³n:** Punto de entrada, proxy reverso, servidor estÃ¡tico
- **VolÃºmenes:**
  - `./nginx/nginx.conf` â†’ `/etc/nginx/nginx.conf`
  - `./nginx/default.conf` â†’ `/etc/nginx/conf.d/default.conf`
  - `./processed_videos` â†’ `/var/www/processed_videos` (read-only)
- **Dependencias:** anb_api

#### 2. **anb_api** - FastAPI Backend
- **Imagen:** Custom (Dockerfile)
- **Base:** `python:3.12-slim`
- **Puertos Expuestos:** `8000:8000`
- **FunciÃ³n:** API REST, lÃ³gica de negocio
- **Variables de Entorno:**
  - `DATABASE_URL=postgresql://anb_user:anb_password@postgres:5432/anb_db`
  - `REDIS_URL=redis://redis:6379/0`
  - `CELERY_BROKER_URL=redis://redis:6379/0`
- **VolÃºmenes:**
  - `./uploads` â†’ `/app/uploads`
  - `./processed_videos` â†’ `/app/processed_videos`
  - `./logs` â†’ `/app/logs`
- **Comando:** `/app/scripts/start.sh` (ejecuta migraciones + uvicorn)
- **Dependencias:** anb_postgres, anb_redis

#### 3. **anb_worker** - Celery Worker
- **Imagen:** Custom (Dockerfile - misma que API)
- **Base:** `python:3.12-slim`
- **FunciÃ³n:** Procesamiento asÃ­ncrono de videos
- **Variables de Entorno:**
  - `DATABASE_URL=postgresql://anb_user:anb_password@postgres:5432/anb_db`
  - `REDIS_URL=redis://redis:6379/0`
  - `CELERY_BROKER_URL=redis://redis:6379/0`
- **VolÃºmenes:**
  - `./uploads` â†’ `/app/uploads`
  - `./processed_videos` â†’ `/app/processed_videos`
  - `./logs` â†’ `/app/logs`
- **Comando:** 
  ```bash
  celery -A app.workers.celery_app worker 
    --loglevel=info 
    --concurrency=2 
    --queues=video_queue
  ```
- **Dependencias:** anb_postgres, anb_redis

#### 4. **anb_flower** - Monitoring Dashboard
- **Imagen:** Custom (Dockerfile)
- **Puertos Expuestos:** `5555:5555`
- **FunciÃ³n:** Dashboard de monitoreo de Celery
- **Variables de Entorno:**
  - `CELERY_BROKER_URL=redis://redis:6379/0`
- **Comando:** 
  ```bash
  celery -A app.workers.celery_app flower --port=5555
  ```
- **Dependencias:** anb_redis

#### 5. **anb_redis** - Message Broker
- **Imagen:** `redis:7-alpine`
- **Puertos Expuestos:** `6379:6379`
- **FunciÃ³n:** 
  - Message broker para Celery
  - Result backend
  - Cache (preparado)
- **VolÃºmenes:**
  - `redis_data` â†’ `/data` (persistencia AOF)
- **Comando:** `redis-server --appendonly yes`
- **PolÃ­tica de Reinicio:** `unless-stopped`

#### 6. **anb_postgres** - Base de Datos
- **Imagen:** `postgres:15-alpine`
- **Puertos Expuestos:** `5432:5432`
- **FunciÃ³n:** Base de datos relacional principal
- **Variables de Entorno:**
  - `POSTGRES_DB=anb_db`
  - `POSTGRES_USER=anb_user`
  - `POSTGRES_PASSWORD=anb_password`
- **VolÃºmenes:**
  - `postgres_data` â†’ `/var/lib/postgresql/data`
  - `./init-db.sql` â†’ `/docker-entrypoint-initdb.d/init-db.sql`
- **PolÃ­tica de Reinicio:** `unless-stopped`

### ðŸ’¾ VolÃºmenes Docker

#### VolÃºmenes Named (Persistentes)
1. **postgres_data** - Datos de PostgreSQL
2. **redis_data** - Datos de Redis (AOF)

#### Bind Mounts (Host â†’ Container)
1. **./uploads** - Videos originales subidos
2. **./processed_videos** - Videos procesados listos
3. **./logs** - Logs de aplicaciÃ³n
4. **./nginx/** - ConfiguraciÃ³n de Nginx

### Red Docker

**Nombre:** `anb_network`  
**Tipo:** `bridge`  
**FunciÃ³n:** Conecta todos los contenedores en una red privada

**ResoluciÃ³n DNS Interna:**
- `postgres` â†’ IP del contenedor PostgreSQL
- `redis` â†’ IP del contenedor Redis
- `api` â†’ IP del contenedor FastAPI

### Puertos y Protocolos

| Puerto | Protocolo | Servicio | Acceso | DescripciÃ³n |
|--------|-----------|----------|--------|-------------|
| 80 | HTTP | Nginx | PÃºblico | API REST y archivos estÃ¡ticos |
| 443 | HTTPS | Nginx | PÃºblico | API REST segura (preparado) |
| 8000 | HTTP | FastAPI | Interno | API REST (solo via Nginx) |
| 5432 | PostgreSQL | PostgreSQL | Interno | Base de datos relacional |
| 6379 | Redis | Redis | Interno | Message broker + cache |
| 5555 | HTTP | Flower | PÃºblico | Dashboard de Celery |

**Aclaraciones:**
- **HTTP/HTTPS**: Protocolo de aplicaciÃ³n sobre TCP/IP
- **PostgreSQL Protocol**: Wire protocol propietario sobre TCP (puerto 5432)
- **Redis Protocol**: RESP (Redis Serialization Protocol) sobre TCP (puerto 6379)
- **File I/O**: Acceso a volÃºmenes Docker via filesystem del host (no red)
- **Volume Mount**: Bind mount o named volume (filesystem, no TCP/IP)

### Flujo de Despliegue

#### 1. ConstrucciÃ³n de ImÃ¡genes
```bash
docker-compose build
```
- Construye imagen custom para: api, worker, flower
- Descarga imÃ¡genes: postgres:15-alpine, redis:7-alpine, nginx:alpine

#### 2. InicializaciÃ³n de Servicios
```bash
docker-compose up -d
```

**Orden de inicio:**
1. `postgres` (base de datos)
2. `redis` (message broker)
3. `api` (espera postgres + redis, ejecuta migraciones)
4. `worker` (espera postgres + redis + api)
5. `flower` (espera redis)
6. `nginx` (espera api)

#### 3. Health Checks
- API: `http://localhost/health`
- Flower: `http://localhost:5555`
- Redis: `redis-cli ping`
- PostgreSQL: `pg_isready`

### Recursos por Contenedor

| Contenedor | CPU | RAM | Disco |
|------------|-----|-----|-------|
| anb_nginx | ~50MB | ~10MB | MÃ­nimo |
| anb_api | Variable | ~200-500MB | Logs |
| anb_worker | Variable | ~300-800MB | Videos |
| anb_flower | MÃ­nimo | ~50MB | MÃ­nimo |
| anb_redis | Bajo | ~50-100MB | Cache |
| anb_postgres | Medio | ~100-300MB | DB |

**Total estimado:** ~1-2GB RAM + 10-50GB disco (depende de videos)

### Seguridad

#### Nivel de Red
- Contenedores en red privada `anb_network`
- Solo Nginx y Flower expuestos pÃºblicamente
- PostgreSQL y Redis NO accesibles desde fuera

#### Nivel de AplicaciÃ³n
- Variables de entorno para credenciales
- Secrets recomendados para producciÃ³n
- HTTPS configurado en Nginx (certificados requeridos)

#### Nivel de Contenedor
- ImÃ¡genes Alpine (mÃ­nima superficie de ataque)
- Usuario no-root en contenedores custom
- Read-only volumes donde sea posible

### ðŸš€ Comandos de GestiÃ³n

#### Iniciar servicios
```bash
docker-compose up -d
```

#### Ver logs
```bash
docker-compose logs -f [servicio]
```

#### Escalar workers
```bash
docker-compose up -d --scale worker=4
```

#### Detener servicios
```bash
docker-compose down
```

#### Detener y limpiar volÃºmenes
```bash
docker-compose down -v
```

#### Ver estado
```bash
docker-compose ps
```

### ActualizaciÃ³n y Rollback

#### Actualizar cÃ³digo
```bash
# Pull de cambios
git pull origin main

# Rebuild y restart
docker-compose up -d --build
```

#### Backup de base de datos
```bash
docker-compose exec postgres pg_dump -U anb_user anb_db > backup.sql
```

#### Restore de base de datos
```bash
docker-compose exec -T postgres psql -U anb_user anb_db < backup.sql
```

### ðŸ“ˆ Escalabilidad

#### Horizontal
- **API:** MÃºltiples replicas detrÃ¡s de Nginx
- **Workers:** Escalar con `--scale worker=N`
- **Nginx:** Load balancer upstream

#### Vertical
- Ajustar recursos Docker (CPU/RAM limits)
- Optimizar configuraciÃ³n de PostgreSQL
- Tuning de Redis

### Preparado para Cloud

La arquitectura Docker es compatible con:
- **AWS:** ECS/Fargate, RDS, ElastiCache
- **GCP:** Cloud Run, Cloud SQL, Memorystore
- **Azure:** Container Instances, Azure Database
- **DigitalOcean:** App Platform, Managed Databases
- **Kubernetes:** Deployment manifests generables

---

**Archivo de despliegue:** `docker-compose.yml`  
**ConfiguraciÃ³n:** Variables de entorno en `.env` o `docker-compose.yml`  
**DocumentaciÃ³n completa:** [docs/DEPLOYMENT.md](../DEPLOYMENT.md)

